
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_uart.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @addtogroup APP_UART</a>
<a name="ln3"> * @{</a>
<a name="ln4"> */</a>
<a name="ln5">/**</a>
<a name="ln6"> *  @file app_uart.c</a>
<a name="ln7"> *  @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln8"> *  @date 2020-05-29</a>
<a name="ln9"> *  @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln10"> *</a>
<a name="ln11"> *  Application UART control, processing incoming data and sending data out.</a>
<a name="ln12"> */</a>
<a name="ln13">#include &quot;app_config.h&quot;</a>
<a name="ln14">#include &quot;app_uart.h&quot;</a>
<a name="ln15">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_endpoint_ca_uart.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_communication_ble_advertising.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_communication_uart.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22">#include &lt;string.h&gt;</a>
<a name="ln23">#include &lt;stdio.h&gt;</a>
<a name="ln24"> </a>
<a name="ln25">static ri_comm_channel_t m_uart; //!&lt; UART communication interface.</a>
<a name="ln26"> </a>
<a name="ln27">/** @brief convert baudrate from board definition for driver. */</a>
<a name="ln28">static ri_uart_baudrate_t rb_to_ri_baud (const uint32_t rb_baud)</a>
<a name="ln29">{</a>
<a name="ln30">    ri_uart_baudrate_t baud;</a>
<a name="ln31"> </a>
<a name="ln32">    switch (rb_baud)</a>
<a name="ln33">    {</a>
<a name="ln34">        case RB_UART_BAUDRATE_9600:</a>
<a name="ln35">            baud = RI_UART_BAUD_9600;</a>
<a name="ln36">            break;</a>
<a name="ln37"> </a>
<a name="ln38">        case RB_UART_BAUDRATE_115200:</a>
<a name="ln39">            baud = RI_UART_BAUD_115200;</a>
<a name="ln40">            break;</a>
<a name="ln41"> </a>
<a name="ln42">        default:</a>
<a name="ln43">            baud = RI_UART_BAUD_115200;</a>
<a name="ln44">            break;</a>
<a name="ln45">    }</a>
<a name="ln46"> </a>
<a name="ln47">    return baud;</a>
<a name="ln48">}</a>
<a name="ln49"> </a>
<a name="ln50">static void setup_uart_init (ri_uart_init_t * const p_init)</a>
<a name="ln51">{</a>
<a name="ln52">    // Ruuvi board pin definitions are compatible with</a>
<a name="ln53">    // Ruuvi driver pin definitions.</a>
<a name="ln54">#if APP_USBUART_ENABLED</a>
<a name="ln55">    p_init-&gt;hwfc_enabled = RB_UART_USB_HWFC_ENABLED;</a>
<a name="ln56">    p_init-&gt;parity_enabled = RB_UART_USB_PARITY_ENABLED;</a>
<a name="ln57">    p_init-&gt;cts = RB_UART_USB_CTS_PIN;</a>
<a name="ln58">    p_init-&gt;rts = RB_UART_USB_RTS_PIN;</a>
<a name="ln59">    p_init-&gt;tx = RB_UART_USB_TX_PIN;</a>
<a name="ln60">    p_init-&gt;rx = RB_UART_USB_RX_PIN;</a>
<a name="ln61">    p_init-&gt;baud = rb_to_ri_baud (RB_UART_BAUDRATE);</a>
<a name="ln62">#else</a>
<a name="ln63">    p_init-&gt;hwfc_enabled = RB_HWFC_ENABLED;</a>
<a name="ln64">    p_init-&gt;parity_enabled = RB_PARITY_ENABLED;</a>
<a name="ln65">    p_init-&gt;cts  = RB_UART_CTS_PIN;</a>
<a name="ln66">    p_init-&gt;rts  = RB_UART_RTS_PIN;</a>
<a name="ln67">    p_init-&gt;tx   = RB_UART_TX_PIN;</a>
<a name="ln68">    p_init-&gt;rx   = RB_UART_RX_PIN;</a>
<a name="ln69">    p_init-&gt;baud = rb_to_ri_baud (RB_UART_BAUDRATE);</a>
<a name="ln70">#endif</a>
<a name="ln71">}</a>
<a name="ln72"> </a>
<a name="ln73">rd_status_t app_uart_init (void)</a>
<a name="ln74">{</a>
<a name="ln75">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln76">    ri_uart_init_t config = { 0 };</a>
<a name="ln77">    setup_uart_init (&amp;config);</a>
<a name="ln78">    err_code |= ri_uart_init (&amp;m_uart);</a>
<a name="ln79">    err_code |= ri_uart_config (&amp;config);</a>
<a name="ln80">    return err_code;</a>
<a name="ln81">}</a>
<a name="ln82"> </a>
<a name="ln83">rd_status_t app_uart_send_broadcast (const ri_adv_scan_t * const scan)</a>
<a name="ln84">{</a>
<a name="ln85">    re_ca_uart_payload_t adv = {0};</a>
<a name="ln86">    ri_comm_message_t msg = {0};</a>
<a name="ln87">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln88">    re_status_t re_code = RE_SUCCESS;</a>
<a name="ln89"> </a>
<a name="ln90">    if (RE_CA_UART_ADV_BYTES &gt;= scan-&gt;data_len)</a>
<a name="ln91">    {</a>
<a name="ln92">        memcpy (adv.params.adv.mac, scan-&gt;addr, sizeof (adv.params.adv.mac));</a>
<a name="ln93">        memcpy (adv.params.adv.adv, scan-&gt;data, scan-&gt;data_len);</a>
<a name="ln94">        adv.params.adv.rssi_db = scan-&gt;rssi;</a>
<a name="ln95">        adv.params.adv.adv_len = scan-&gt;data_len;</a>
<a name="ln96">        adv.cmd = RE_CA_UART_ADV_RPRT;</a>
<a name="ln97">        msg.data_length = sizeof (msg);</a>
<a name="ln98">        re_code = re_ca_uart_encode (msg.data, &amp;msg.data_length, &amp;adv);</a>
<a name="ln99">        msg.repeat_count = 1;</a>
<a name="ln100"> </a>
<a name="ln101">        if (RE_SUCCESS == re_code)</a>
<a name="ln102">        {</a>
<a name="ln103">            err_code |= m_uart.send (&amp;msg);</a>
<a name="ln104">        }</a>
<a name="ln105">        else</a>
<a name="ln106">        {</a>
<a name="ln107">            err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln108">        }</a>
<a name="ln109">    }</a>
<a name="ln110">    else</a>
<a name="ln111">    {</a>
<a name="ln112">        err_code |= RD_ERROR_DATA_SIZE;</a>
<a name="ln113">    }</a>
<a name="ln114"> </a>
<a name="ln115">    return err_code;</a>
<a name="ln116">}</a>
<a name="ln117"> </a>
<a name="ln118">/** @} */</a>

</code></pre>
<div class="balloon" rel="63"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="64"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="65"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0xFFFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="66"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0xFFFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="67"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(((0U) << 8U) + (31U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="68"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(((0U) << 8U) + (12U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="95"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'scan->data_len' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="97"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="99"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
