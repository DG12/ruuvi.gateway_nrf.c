
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>app_uart.c</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @addtogroup APP_UART</a>
<a name="ln3"> * @{</a>
<a name="ln4"> */</a>
<a name="ln5">/**</a>
<a name="ln6"> *  @file app_uart.c</a>
<a name="ln7"> *  @author Otso Jousimaa &lt;otso@ojousima.net&gt;</a>
<a name="ln8"> *  @date 2020-05-29</a>
<a name="ln9"> *  @copyright Ruuvi Innovations Ltd, license BSD-3-Clause.</a>
<a name="ln10"> *</a>
<a name="ln11"> *  Application UART control, processing incoming data and sending data out.</a>
<a name="ln12"> */</a>
<a name="ln13">#include &quot;app_config.h&quot;</a>
<a name="ln14">#include &quot;app_uart.h&quot;</a>
<a name="ln15">#include &quot;app_ble.h&quot;</a>
<a name="ln16">#include &quot;ruuvi_boards.h&quot;</a>
<a name="ln17">#include &quot;ruuvi_driver_error.h&quot;</a>
<a name="ln18">#include &quot;ruuvi_endpoint_ca_uart.h&quot;</a>
<a name="ln19">#include &quot;ruuvi_interface_communication.h&quot;</a>
<a name="ln20">#include &quot;ruuvi_interface_communication_radio.h&quot;</a>
<a name="ln21">#include &quot;ruuvi_interface_communication_ble_advertising.h&quot;</a>
<a name="ln22">#include &quot;ruuvi_interface_watchdog.h&quot;</a>
<a name="ln23">#include &quot;ruuvi_interface_scheduler.h&quot;</a>
<a name="ln24">#include &quot;ruuvi_interface_communication_uart.h&quot;</a>
<a name="ln25">#include &quot;ruuvi_library_ringbuffer.h&quot;</a>
<a name="ln26"> </a>
<a name="ln27">#include &lt;string.h&gt;</a>
<a name="ln28">#include &lt;stdio.h&gt;</a>
<a name="ln29"> </a>
<a name="ln30">#define APP_UART_RING_BUFFER_MAX_LEN     (128U) //!&lt; Ring buffer len       </a>
<a name="ln31">#define APP_UART_RING_DEQ_BUFFER_MAX_LEN (APP_UART_RING_BUFFER_MAX_LEN &gt;&gt;1) //!&lt; Decode buffer len</a>
<a name="ln32"> </a>
<a name="ln33">#ifndef CEEDLING</a>
<a name="ln34">static bool app_uart_ringbuffer_lock_dummy (volatile uint32_t * const flag, bool lock);</a>
<a name="ln35">#endif</a>
<a name="ln36"> </a>
<a name="ln37">static ri_comm_channel_t m_uart; //!&lt; UART communication interface.</a>
<a name="ln38">static uint8_t buffer_data[APP_UART_RING_BUFFER_MAX_LEN] = {0};</a>
<a name="ln39">static bool buffer_wlock = false;</a>
<a name="ln40">static bool buffer_rlock = false;</a>
<a name="ln41">static rl_ringbuffer_t m_uart_ring_buffer =</a>
<a name="ln42">{</a>
<a name="ln43">    .head = 0,</a>
<a name="ln44">    .tail = 0,</a>
<a name="ln45">    .block_size = sizeof (uint8_t),</a>
<a name="ln46">    .storage_size = sizeof (buffer_data),</a>
<a name="ln47">    .index_mask = (sizeof (buffer_data) / sizeof (uint8_t)) - 1,</a>
<a name="ln48">    .storage = buffer_data,</a>
<a name="ln49">    .lock = app_uart_ringbuffer_lock_dummy,</a>
<a name="ln50">    .writelock = &amp;buffer_wlock,</a>
<a name="ln51">    .readlock  = &amp;buffer_rlock</a>
<a name="ln52">};</a>
<a name="ln53"> </a>
<a name="ln54">/** Dummy function to lock/unlock buffer */</a>
<a name="ln55">#ifndef CEEDLING</a>
<a name="ln56">static</a>
<a name="ln57">#endif</a>
<a name="ln58">bool app_uart_ringbuffer_lock_dummy (volatile uint32_t * const flag, bool lock)</a>
<a name="ln59">{</a>
<a name="ln60">    bool * p_bool = (bool *) flag;</a>
<a name="ln61"> </a>
<a name="ln62">    if (*p_bool == lock) { return false; }</a>
<a name="ln63"> </a>
<a name="ln64">    *p_bool = lock;</a>
<a name="ln65">    return true;</a>
<a name="ln66">}</a>
<a name="ln67"> </a>
<a name="ln68">#ifndef CEEDLING</a>
<a name="ln69">static</a>
<a name="ln70">rd_status_t app_uart_apply_config (re_ca_uart_payload_t * p_uart_payload)</a>
<a name="ln71">#else</a>
<a name="ln72">rd_status_t app_uart_apply_config (void * v_uart_payload)</a>
<a name="ln73">#endif</a>
<a name="ln74">{</a>
<a name="ln75">#ifdef CEEDLING</a>
<a name="ln76">    re_ca_uart_payload_t * p_uart_payload = (re_ca_uart_payload_t *) v_uart_payload;</a>
<a name="ln77">#endif</a>
<a name="ln78">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln79">    ri_radio_modulation_t modulation;</a>
<a name="ln80">    ri_radio_channels_t channels;</a>
<a name="ln81"> </a>
<a name="ln82">    switch (p_uart_payload-&gt;cmd)</a>
<a name="ln83">    {</a>
<a name="ln84">        case RE_CA_UART_SET_FLTR_TAGS:</a>
<a name="ln85">            err_code |= app_ble_manufacturer_filter_set ( (bool)</a>
<a name="ln86">                        p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln87">            break;</a>
<a name="ln88"> </a>
<a name="ln89">        case RE_CA_UART_SET_FLTR_ID:</a>
<a name="ln90">            err_code |= app_ble_manufacturer_id_set (p_uart_payload-&gt;params.fltr_id_param.id);</a>
<a name="ln91">            break;</a>
<a name="ln92"> </a>
<a name="ln93">        case RE_CA_UART_SET_CODED_PHY:</a>
<a name="ln94">            modulation = RI_RADIO_BLE_125KBPS;</a>
<a name="ln95">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln96">                                                   (bool) p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln97">            break;</a>
<a name="ln98"> </a>
<a name="ln99">        case RE_CA_UART_SET_SCAN_1MB_PHY:</a>
<a name="ln100">            modulation = RI_RADIO_BLE_1MBPS;</a>
<a name="ln101">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln102">                                                   (bool) p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln103">            break;</a>
<a name="ln104"> </a>
<a name="ln105">        case RE_CA_UART_SET_EXT_PAYLOAD:</a>
<a name="ln106">            modulation = RI_RADIO_BLE_2MBPS;</a>
<a name="ln107">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln108">                                                   (bool) p_uart_payload-&gt;params.bool_param.state);</a>
<a name="ln109">            break;</a>
<a name="ln110"> </a>
<a name="ln111">        case RE_CA_UART_SET_CH_37:</a>
<a name="ln112">            err_code |= app_ble_channels_get (&amp;channels);</a>
<a name="ln113">            channels.channel_37 = p_uart_payload-&gt;params.bool_param.state;</a>
<a name="ln114">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln115">            break;</a>
<a name="ln116"> </a>
<a name="ln117">        case RE_CA_UART_SET_CH_38:</a>
<a name="ln118">            err_code |= app_ble_channels_get (&amp;channels);</a>
<a name="ln119">            channels.channel_38 = p_uart_payload-&gt;params.bool_param.state;</a>
<a name="ln120">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln121">            break;</a>
<a name="ln122"> </a>
<a name="ln123">        case RE_CA_UART_SET_CH_39:</a>
<a name="ln124">            err_code |= app_ble_channels_get (&amp;channels);</a>
<a name="ln125">            channels.channel_39 = p_uart_payload-&gt;params.bool_param.state;</a>
<a name="ln126">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln127">            break;</a>
<a name="ln128"> </a>
<a name="ln129">        case RE_CA_UART_SET_ALL:</a>
<a name="ln130">            err_code |= app_ble_manufacturer_id_set (p_uart_payload-&gt;params.all_params.fltr_id.id);</a>
<a name="ln131">            err_code |= app_ble_manufacturer_filter_set ( (bool)</a>
<a name="ln132">                        p_uart_payload-&gt;params.all_params.bools.fltr_tags.state);</a>
<a name="ln133">            channels.channel_37 = p_uart_payload-&gt;params.all_params.bools.ch_37.state;</a>
<a name="ln134">            channels.channel_38 = p_uart_payload-&gt;params.all_params.bools.ch_38.state;</a>
<a name="ln135">            channels.channel_39 = p_uart_payload-&gt;params.all_params.bools.ch_39.state;</a>
<a name="ln136">            err_code |= app_ble_channels_set (channels);</a>
<a name="ln137">            modulation = RI_RADIO_BLE_125KBPS;</a>
<a name="ln138">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln139">                                                   (bool) p_uart_payload-&gt;params.all_params.bools.coded_phy.state);</a>
<a name="ln140">            modulation = RI_RADIO_BLE_1MBPS;</a>
<a name="ln141">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln142">                                                   (bool) p_uart_payload-&gt;params.all_params.bools.scan_phy.state);</a>
<a name="ln143">            modulation = RI_RADIO_BLE_2MBPS;</a>
<a name="ln144">            err_code |= app_ble_modulation_enable (modulation,</a>
<a name="ln145">                                                   (bool) p_uart_payload-&gt;params.all_params.bools.ext_payload.state);</a>
<a name="ln146">            break;</a>
<a name="ln147"> </a>
<a name="ln148">        default:</a>
<a name="ln149">            err_code |= RE_ERROR_INVALID_PARAM;</a>
<a name="ln150">            break;</a>
<a name="ln151">    }</a>
<a name="ln152"> </a>
<a name="ln153">    return err_code;</a>
<a name="ln154">}</a>
<a name="ln155">#if 0</a>
<a name="ln156">#ifndef CEEDLING</a>
<a name="ln157">static</a>
<a name="ln158">#endif</a>
<a name="ln159">void app_uart_repeat_send (void * p_data, uint16_t data_len)</a>
<a name="ln160">{</a>
<a name="ln161">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln162">    ri_comm_message_t msg = {0};</a>
<a name="ln163">    msg.repeat_count = 1;</a>
<a name="ln164">    msg.data_length = data_len;</a>
<a name="ln165">    memcpy (msg.data, p_data, data_len);</a>
<a name="ln166">    err_code |= m_uart.send (&amp;msg);</a>
<a name="ln167"> </a>
<a name="ln168">    if (RE_SUCCESS != err_code)</a>
<a name="ln169">    {</a>
<a name="ln170">        err_code |= ri_scheduler_event_put (msg.data, (uint16_t) msg.data_length,</a>
<a name="ln171">                                            app_uart_repeat_send);</a>
<a name="ln172">    }</a>
<a name="ln173"> </a>
<a name="ln174">    if (RD_SUCCESS == err_code)</a>
<a name="ln175">    {</a>
<a name="ln176">        ri_watchdog_feed();</a>
<a name="ln177">    }</a>
<a name="ln178">}</a>
<a name="ln179">#endif</a>
<a name="ln180"> </a>
<a name="ln181">#ifndef CEEDLING</a>
<a name="ln182">static</a>
<a name="ln183">#endif</a>
<a name="ln184">void app_uart_parser (void * p_data, uint16_t data_len)</a>
<a name="ln185">{</a>
<a name="ln186">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln187">    ri_comm_message_t msg = {0};</a>
<a name="ln188">    re_ca_uart_payload_t uart_payload = {0};</a>
<a name="ln189">    uint8_t dequeue_data[APP_UART_RING_DEQ_BUFFER_MAX_LEN] = {0};</a>
<a name="ln190">    rl_status_t status;</a>
<a name="ln191">    size_t index = 0;</a>
<a name="ln192">    err_code = re_ca_uart_decode ( (uint8_t *) p_data, &amp;uart_payload);</a>
<a name="ln193"> </a>
<a name="ln194">    if (RD_SUCCESS == err_code)</a>
<a name="ln195">    {</a>
<a name="ln196">        if (false == rl_ringbuffer_empty (&amp;m_uart_ring_buffer))</a>
<a name="ln197">        {</a>
<a name="ln198">            do</a>
<a name="ln199">            {</a>
<a name="ln200">                uint8_t * p_dequeue_data;</a>
<a name="ln201">                status = rl_ringbuffer_dequeue (&amp;m_uart_ring_buffer,</a>
<a name="ln202">                                                &amp;p_dequeue_data);</a>
<a name="ln203">                dequeue_data[index++] = *p_dequeue_data;</a>
<a name="ln204">            } while (RL_SUCCESS == status);</a>
<a name="ln205">        }</a>
<a name="ln206">    }</a>
<a name="ln207">    else</a>
<a name="ln208">    {</a>
<a name="ln209">        do</a>
<a name="ln210">        {</a>
<a name="ln211">            status = rl_ringbuffer_queue (&amp;m_uart_ring_buffer,</a>
<a name="ln212">                                          (void *) ( (uint8_t *) p_data + index),</a>
<a name="ln213">                                          sizeof (uint8_t));</a>
<a name="ln214">            index++;</a>
<a name="ln215">        } while ( (RL_SUCCESS == status) &amp;&amp; (index &lt; data_len));</a>
<a name="ln216"> </a>
<a name="ln217">        index = 0;</a>
<a name="ln218"> </a>
<a name="ln219">        do</a>
<a name="ln220">        {</a>
<a name="ln221">            uint8_t * p_dequeue_data;</a>
<a name="ln222">            status = rl_ringbuffer_dequeue (&amp;m_uart_ring_buffer,</a>
<a name="ln223">                                            &amp;p_dequeue_data);</a>
<a name="ln224">            dequeue_data[index++] = *p_dequeue_data;</a>
<a name="ln225">        } while (RL_SUCCESS == status);</a>
<a name="ln226"> </a>
<a name="ln227">        err_code = re_ca_uart_decode ( (uint8_t *) dequeue_data, &amp;uart_payload);</a>
<a name="ln228"> </a>
<a name="ln229">        if (RD_SUCCESS != err_code)</a>
<a name="ln230">        {</a>
<a name="ln231">            size_t len = index - 1;</a>
<a name="ln232">            index = 0;</a>
<a name="ln233"> </a>
<a name="ln234">            do</a>
<a name="ln235">            {</a>
<a name="ln236">                status = rl_ringbuffer_queue (&amp;m_uart_ring_buffer, (void *) (dequeue_data + index),</a>
<a name="ln237">                                              sizeof (uint8_t));</a>
<a name="ln238">                index++;</a>
<a name="ln239">            } while ( (RL_SUCCESS == status) &amp;&amp; (index &lt; len));</a>
<a name="ln240">        }</a>
<a name="ln241">    }</a>
<a name="ln242"> </a>
<a name="ln243">    if (RD_SUCCESS == err_code)</a>
<a name="ln244">    {</a>
<a name="ln245">        if (RE_CA_UART_GET_DEVICE_ID == uart_payload.cmd)</a>
<a name="ln246">        {</a>
<a name="ln247">            uint64_t mac;</a>
<a name="ln248">            uint64_t id;</a>
<a name="ln249">            ri_radio_address_get (&amp;mac);</a>
<a name="ln250">            ri_comm_id_get (&amp;id);</a>
<a name="ln251">            uart_payload.cmd = RE_CA_UART_DEVICE_ID;</a>
<a name="ln252">            uart_payload.params.device_id.id = id;</a>
<a name="ln253">            uart_payload.params.device_id.addr = mac;</a>
<a name="ln254">            msg.data_length = sizeof (msg);</a>
<a name="ln255">        }</a>
<a name="ln256">        else</a>
<a name="ln257">        {</a>
<a name="ln258">            if (RD_SUCCESS == app_uart_apply_config (&amp;uart_payload))</a>
<a name="ln259">            {</a>
<a name="ln260">                uart_payload.params.ack.ack_state.state = RE_CA_ACK_OK;</a>
<a name="ln261">            }</a>
<a name="ln262">            else</a>
<a name="ln263">            {</a>
<a name="ln264">                uart_payload.params.ack.ack_state.state = RE_CA_ACK_ERROR;</a>
<a name="ln265">            }</a>
<a name="ln266"> </a>
<a name="ln267">            uart_payload.params.ack.cmd = uart_payload.cmd;</a>
<a name="ln268">            uart_payload.cmd = RE_CA_UART_ACK;</a>
<a name="ln269">            msg.data_length = sizeof (msg);</a>
<a name="ln270">        }</a>
<a name="ln271"> </a>
<a name="ln272">        err_code = re_ca_uart_encode (msg.data, &amp;msg.data_length, &amp;uart_payload);</a>
<a name="ln273">        msg.repeat_count = 1;</a>
<a name="ln274"> </a>
<a name="ln275">        if (RE_SUCCESS == err_code)</a>
<a name="ln276">        {</a>
<a name="ln277">            err_code |= m_uart.send (&amp;msg);</a>
<a name="ln278">#if 0</a>
<a name="ln279"> </a>
<a name="ln280">            if (RE_SUCCESS != err_code)</a>
<a name="ln281">            {</a>
<a name="ln282">                err_code |= ri_scheduler_event_put (msg.data, (uint16_t) msg.data_length,</a>
<a name="ln283">                                                    app_uart_repeat_send);</a>
<a name="ln284">            }</a>
<a name="ln285"> </a>
<a name="ln286">#endif</a>
<a name="ln287">        }</a>
<a name="ln288">        else</a>
<a name="ln289">        {</a>
<a name="ln290">            err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln291">        }</a>
<a name="ln292">    }</a>
<a name="ln293"> </a>
<a name="ln294">    if (RD_SUCCESS == err_code)</a>
<a name="ln295">    {</a>
<a name="ln296">        ri_watchdog_feed();</a>
<a name="ln297">    }</a>
<a name="ln298">}</a>
<a name="ln299"> </a>
<a name="ln300">#ifndef CEEDLING</a>
<a name="ln301">static</a>
<a name="ln302">#endif</a>
<a name="ln303">rd_status_t app_uart_isr (ri_comm_evt_t evt,</a>
<a name="ln304">                          void * p_data, size_t data_len)</a>
<a name="ln305">{</a>
<a name="ln306">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln307"> </a>
<a name="ln308">    switch (evt)</a>
<a name="ln309">    {</a>
<a name="ln310">        case RI_COMM_SENT:</a>
<a name="ln311">            break;</a>
<a name="ln312"> </a>
<a name="ln313">        case RI_COMM_RECEIVED:</a>
<a name="ln314">            err_code |= ri_scheduler_event_put (p_data, (uint16_t) data_len, app_uart_parser);</a>
<a name="ln315">            break;</a>
<a name="ln316"> </a>
<a name="ln317">        default:</a>
<a name="ln318">            break;</a>
<a name="ln319">    }</a>
<a name="ln320"> </a>
<a name="ln321">    RD_ERROR_CHECK (err_code, ~RD_ERROR_FATAL);</a>
<a name="ln322">    return err_code;</a>
<a name="ln323">}</a>
<a name="ln324"> </a>
<a name="ln325">/** @brief convert baudrate from board definition for driver. */</a>
<a name="ln326">static ri_uart_baudrate_t rb_to_ri_baud (const uint32_t rb_baud)</a>
<a name="ln327">{</a>
<a name="ln328">    ri_uart_baudrate_t baud;</a>
<a name="ln329"> </a>
<a name="ln330">    switch (rb_baud)</a>
<a name="ln331">    {</a>
<a name="ln332">        case RB_UART_BAUDRATE_9600:</a>
<a name="ln333">            baud = RI_UART_BAUD_9600;</a>
<a name="ln334">            break;</a>
<a name="ln335"> </a>
<a name="ln336">        case RB_UART_BAUDRATE_115200:</a>
<a name="ln337">            baud = RI_UART_BAUD_115200;</a>
<a name="ln338">            break;</a>
<a name="ln339"> </a>
<a name="ln340">        default:</a>
<a name="ln341">            baud = RI_UART_BAUD_115200;</a>
<a name="ln342">            break;</a>
<a name="ln343">    }</a>
<a name="ln344"> </a>
<a name="ln345">    return baud;</a>
<a name="ln346">}</a>
<a name="ln347"> </a>
<a name="ln348">static void setup_uart_init (ri_uart_init_t * const p_init)</a>
<a name="ln349">{</a>
<a name="ln350">    // Ruuvi board pin definitions are compatible with</a>
<a name="ln351">    // Ruuvi driver pin definitions.</a>
<a name="ln352">#if APP_USBUART_ENABLED</a>
<a name="ln353">    p_init-&gt;hwfc_enabled = RB_UART_USB_HWFC_ENABLED;</a>
<a name="ln354">    p_init-&gt;parity_enabled = RB_UART_USB_PARITY_ENABLED;</a>
<a name="ln355">    p_init-&gt;cts = RB_UART_USB_CTS_PIN;</a>
<a name="ln356">    p_init-&gt;rts = RB_UART_USB_RTS_PIN;</a>
<a name="ln357">    p_init-&gt;tx = RB_UART_USB_TX_PIN;</a>
<a name="ln358">    p_init-&gt;rx = RB_UART_USB_RX_PIN;</a>
<a name="ln359">    p_init-&gt;baud = rb_to_ri_baud (RB_UART_BAUDRATE);</a>
<a name="ln360">#else</a>
<a name="ln361">    p_init-&gt;hwfc_enabled = RB_HWFC_ENABLED;</a>
<a name="ln362">    p_init-&gt;parity_enabled = RB_PARITY_ENABLED;</a>
<a name="ln363">    p_init-&gt;cts  = RB_UART_CTS_PIN;</a>
<a name="ln364">    p_init-&gt;rts  = RB_UART_RTS_PIN;</a>
<a name="ln365">    p_init-&gt;tx   = RB_UART_TX_PIN;</a>
<a name="ln366">    p_init-&gt;rx   = RB_UART_RX_PIN;</a>
<a name="ln367">    p_init-&gt;baud = rb_to_ri_baud (RB_UART_BAUDRATE);</a>
<a name="ln368">#endif</a>
<a name="ln369">}</a>
<a name="ln370"> </a>
<a name="ln371">rd_status_t app_uart_init (void)</a>
<a name="ln372">{</a>
<a name="ln373">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln374">    ri_uart_init_t config = { 0 };</a>
<a name="ln375">    setup_uart_init (&amp;config);</a>
<a name="ln376">    err_code |= ri_uart_init (&amp;m_uart);</a>
<a name="ln377"> </a>
<a name="ln378">    if (RD_SUCCESS == err_code)</a>
<a name="ln379">    {</a>
<a name="ln380">        m_uart.on_evt = app_uart_isr;</a>
<a name="ln381">        err_code |= ri_uart_config (&amp;config);</a>
<a name="ln382">    }</a>
<a name="ln383"> </a>
<a name="ln384">    return err_code;</a>
<a name="ln385">}</a>
<a name="ln386"> </a>
<a name="ln387">rd_status_t app_uart_send_broadcast (const ri_adv_scan_t * const scan)</a>
<a name="ln388">{</a>
<a name="ln389">    re_ca_uart_payload_t adv = {0};</a>
<a name="ln390">    ri_comm_message_t msg = {0};</a>
<a name="ln391">    rd_status_t err_code = RD_SUCCESS;</a>
<a name="ln392">    re_status_t re_code = RE_SUCCESS;</a>
<a name="ln393"> </a>
<a name="ln394">    if (NULL == scan)</a>
<a name="ln395">    {</a>
<a name="ln396">        err_code |= RD_ERROR_NULL;</a>
<a name="ln397">    }</a>
<a name="ln398">    else if (RE_CA_UART_ADV_BYTES &gt;= scan-&gt;data_len)</a>
<a name="ln399">    {</a>
<a name="ln400">        memcpy (adv.params.adv.mac, scan-&gt;addr, sizeof (adv.params.adv.mac));</a>
<a name="ln401">        memcpy (adv.params.adv.adv, scan-&gt;data, scan-&gt;data_len);</a>
<a name="ln402">        adv.params.adv.rssi_db = scan-&gt;rssi;</a>
<a name="ln403">        adv.params.adv.adv_len = scan-&gt;data_len;</a>
<a name="ln404">        adv.cmd = RE_CA_UART_ADV_RPRT;</a>
<a name="ln405">        msg.data_length = sizeof (msg);</a>
<a name="ln406">        re_code = re_ca_uart_encode (msg.data, &amp;msg.data_length, &amp;adv);</a>
<a name="ln407">        msg.repeat_count = 1;</a>
<a name="ln408"> </a>
<a name="ln409">        if (RE_SUCCESS == re_code)</a>
<a name="ln410">        {</a>
<a name="ln411">            err_code |= m_uart.send (&amp;msg);</a>
<a name="ln412">        }</a>
<a name="ln413">        else</a>
<a name="ln414">        {</a>
<a name="ln415">            err_code |= RD_ERROR_INVALID_DATA;</a>
<a name="ln416">        }</a>
<a name="ln417">    }</a>
<a name="ln418">    else</a>
<a name="ln419">    {</a>
<a name="ln420">        err_code |= RD_ERROR_DATA_SIZE;</a>
<a name="ln421">    }</a>
<a name="ln422"> </a>
<a name="ln423">    return err_code;</a>
<a name="ln424">}</a>
<a name="ln425"> </a>
<a name="ln426">/** @} */</a>

</code></pre>
<div class="balloon" rel="47"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="60"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2545/" target="_blank">V2545</a> Conversion between pointers to the 'unsigned int' type and the '_Bool' type should not be performed. Consider inspecting the expression: '(_Bool *) flag'.</p></div>
<div class="balloon" rel="60"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2567/" target="_blank">V2567</a> The cast should not remove 'volatile' qualification from the type that is pointed to by a pointer.</p></div>
<div class="balloon" rel="56"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2506/" target="_blank">V2506</a> A function should have a single point of exit at the end.</p></div>
<div class="balloon" rel="85"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="96"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="96"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="102"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="102"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="108"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> The 'p_uart_payload->params.bool_param.state' expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="108"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="131"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="139"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="139"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="142"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="142"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2531/" target="_blank">V2531</a> Expression of the essential 'unsigned' type should not be cast to the essential 'Boolean' type.</p></div>
<div class="balloon" rel="145"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> Value of the expression should not be converted from the essential 'Boolean' type to the essential 'ri_radio_modulation_t' type.</p></div>
<div class="balloon" rel="192"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(uint8_t *) p_data'.</p></div>
<div class="balloon" rel="196"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '==' operator should have the same essential type. The current types are: 'signed' and 'Boolean'.</p></div>
<div class="balloon" rel="202"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v614/" target="_blank">V614</a> Uninitialized pointer 'p_dequeue_data' used. Consider checking the second actual argument of the 'rl_ringbuffer_dequeue' function.</p></div>
<div class="balloon" rel="202"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2538/" target="_blank">V2538</a> The value of uninitialized variable 'p_dequeue_data' should not be used. Consider checking the second actual argument of the 'rl_ringbuffer_dequeue' function.</p></div>
<div class="balloon" rel="212"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2571/" target="_blank">V2571</a> Pointer to void should not be converted to a pointer to object. Consider inspecting the expression: '(uint8_t *) p_data'.</p></div>
<div class="balloon" rel="212"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2562/" target="_blank">V2562</a> Expressions with pointer type should not be used in the '+', '-', '+=' and '-=' operations.</p></div>
<div class="balloon" rel="217"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="223"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v614/" target="_blank">V614</a> Uninitialized pointer 'p_dequeue_data' used. Consider checking the second actual argument of the 'rl_ringbuffer_dequeue' function.</p></div>
<div class="balloon" rel="223"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2538/" target="_blank">V2538</a> The value of uninitialized variable 'p_dequeue_data' should not be used. Consider checking the second actual argument of the 'rl_ringbuffer_dequeue' function.</p></div>
<div class="balloon" rel="231"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '-' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="232"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="236"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2562/" target="_blank">V2562</a> Expressions with pointer type should not be used in the '+', '-', '+=' and '-=' operations.</p></div>
<div class="balloon" rel="254"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="260"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="264"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="269"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="273"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>
<div class="balloon" rel="317"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2519/" target="_blank">V2519</a> The 'default' label should, besides a 'break' statement, contain either a statement or a comment.</p></div>
<div class="balloon" rel="304"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2009/" target="_blank">V2009</a> Consider rendering the 'p_data' pointer as a pointer to const.</p></div>
<div class="balloon" rel="361"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="362"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'Boolean' and 'signed'.</p></div>
<div class="balloon" rel="363"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0xFFFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="364"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(0xFFFFU)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="365"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(((0U) << 8U) + (31U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="366"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the '(((0U) << 8U) + (12U))' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="403"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'scan->data_len' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="405"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2572/" target="_blank">V2572</a> The value of the 'sizeof (msg)' expression should not be converted to the narrower essential 'unsigned' type.</p></div>
<div class="balloon" rel="407"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v2568/" target="_blank">V2568</a> Both operands of the '=' operator should have the same essential type. The current types are: 'unsigned' and 'signed'.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
